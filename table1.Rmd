---
title: "Personalized Monitoring of HIV Viral Load Through Prognostic Healthcare (#179)"
author: "IeDEA | FIMP"
output:
  Grmd::docx_document
---

<style type="text/css">
body {
  max-width: 130em !important;
}
</style>

```{r setup, include=FALSE}
options(java.parameters = "-Xmx15g")

knitr::opts_chunk$set(warning=FALSE,
                      message=FALSE,
                      echo=FALSE,
                      #dpi=96,
                     # fig.width=7,# fig.height=4, # Default figure widths
                     # dev="png", #dev.args=list(type="cairo"), # The png device
                      # Change to dev="postscript" if you want the EPS-files
                      # for submitting. Also remove the dev.args() as the postscript
                      # doesn't accept the type="cairo" argument.
                      error=FALSE)
 
# Evaluate the figure caption after the plot
#knitr::opts_knit$set(eval.after='fig.cap')
 
# Use the table counter that the htmlTable() provides
options(table_counter = TRUE)
 
# Use the figCapNo() with roman letters
#options(fig_caption_no_roman = TRUE)
#options(kableExtra.latex.load_packages = F)

# Then install the Grmd-package by running below code:
#devtools::install_github("gforge/Grmd")

#devtools::install_github("kassambara/easyGgplot2")
library(easyGgplot2)

# function to install missing packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos='http://cran.rstudio.com/')
  sapply(pkg, require, character.only = TRUE)
}

#install.packages('package_name', dependencies=TRUE, repos='http://cran.rstudio.com/')

packages =c( "dplyr",  "readxl","Hmisc","Gmisc", "magrittr", "flextable", "MASS", "tidyverse", "caret", "knitr", "kableExtra","xtable", "stargazer", "ggpubr", "haven")

ipak(packages)


select = dplyr::select; summarize = dplyr::summarize; rename = dplyr::rename; mutate = dplyr::mutate;

#source("unbalanced_functions.R")
source("table1_utils.R")
```



```{r warning=FALSE}
rural.cb <- tibble::tribble(
              ~code, ~label,
                     1,'Urban', 2,'Mostly urban', 3,'Mostly rural', 4,'Rural', 9,'Unknown'
              )

level.cb <- tibble::tribble(
              ~code, ~label,
                     1,'Health centre',2,'District hospital',3,'Regional, provincial or university hospital',9,'Unknown'
              )

civstfmt.cb <- tibble::tribble(
              ~code, ~label,
                      1,'Never Married and Not Living w/Partner',2,'Legally Married',3,'Living w/Partner',4,'Separated',5,'Divorced',6,'Widowed'
              )

entptfmt.cb <- tibble::tribble(
              ~code, ~label,
                        1,'outpatient care',2,'inpatient care',3,'pmtct care',4,'TB ward care',
                        5,'community-based org',6,'private care',7,'self-referral',8,'other',
                        9,'RTC (routine testing and counseling)',10,'VCT',11,'HCT(home-based)',
                        12,'MCH (mother child health)',13,'TB clinic',14,'Research Institute',15,'Family Member',
                        16,'Transfer-In',17,'STI Clinic',18,'Unknown',19,'Exposed infant',20,'Under 5 yrs',
                        21,'IDU outreach',22,'YYC(Young Child Clinic)'
              )


pillfmt.cb <- tibble::tribble(
              ~code, ~label,
                      1,'none',2,'very few',3,'about half',4,'most',5,'all'
              )

adhfmt.cb <- tibble::tribble(
              ~code, ~label,
                     1,'Good: 3 or fewer missed doses since last visit',
                     2,'Poor: 4 or more missed doses since last visit',3,'Good: fewer than 2 missed days',
                     4,'Poor: 2 or more missed days'
              )

arvadfmt.cb <- tibble::tribble(
              ~code, ~label,
                     1,'GOOD (>, 95%)',2,'FAIR (85-94%)',3,'POOR (< 85%)'
              )

ynfmt.cb <- tibble::tribble(
              ~code, ~label,
                      1,'Yes',2,'No'
              )

zeroonefmt.cb <- tibble::tribble(
              ~code, ~label,
                      1,'Yes',0,'No'
              )
```

## Assumptions

```{r warning=F}
getFirstXnonNA=function(data,n=3,var){
  #first = dplyr::first(na.omit(value))
  return(data %>%
                  arrange(ptidno, `apptdate`) %>%
                  group_by(ptidno) %>%
                  filter(visit_num <= n) %>%
                  mutate(
                    var_new=dplyr::first(na.omit(!!as.symbol(var)))
                  )%>%
                  ungroup())%>%
                  filter(visit_num == 1)

  #filter(apptdate == min(apptdate)) %>%
}

getFirstNonNAInXMonths=function(data,m=3,var){
  #first = dplyr::first(na.omit(value))
  days=m*30
  return(data %>%
                  arrange(ptidno, `apptdate`) %>%
                  group_by(ptidno) %>%
                  filter(apptdate <= min(apptdate)+days) %>%
                  mutate(
                    var_new=dplyr::first(na.omit(!!as.symbol(var)))
                  )%>%
                  ungroup())%>%
                  filter(visit_num == 1)

  #filter(apptdate == min(apptdate)) %>%
}

```




```{r warning=F}
# Import Dataset
patient.long = haven::read_sas("ak_vlmonitorl.sas7bdat") %>%
                  arrange(ptidno, `apptdate`) %>%
                  group_by(ptidno) %>%
                  mutate(visit_num = row_number())%>%
                  mutate(
                    # vl date
                    vl1_date =  as.Date(dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate)),1), origin="1970-01-01"),
                    vl2_date =  as.Date(dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate)),2), origin="1970-01-01"),
                    vl3_date =  as.Date(dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate)),3), origin="1970-01-01"),
                    
                    # num days to vl
                    
                    num_days_to_vl1 =  dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate-min(apptdate))),1),
                    num_days_to_vl2 =  dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate-min(apptdate))),2),
                    num_days_to_vl3 =  dplyr::nth(na.omit(ifelse(is.na(viralload), NA , apptdate-min(apptdate))),3),
                    
                    # difference in days between vl2 and vl2
                    days_from_vl1_vl2 = num_days_to_vl2- num_days_to_vl1,
                    days_from_vl2_vl3 = num_days_to_vl3- num_days_to_vl2,
      
                    
                  
                    # vl count
                    vl_count1 = dplyr::nth(na.omit(viralload),1),
                    vl_count2 = dplyr::nth(na.omit(viralload),2),
                    vl_count3 = dplyr::nth(na.omit(viralload),3),
                    
                    # num encunters to vl
                    num_encs_to_vl1 = dplyr::nth(na.omit(ifelse(is.na(viralload), NA , visit_num-1)),1),
                    num_encs_to_vl2 = dplyr::nth(na.omit(ifelse(is.na(viralload), NA , visit_num-1)),2),
                    num_encs_to_vl3 = dplyr::nth(na.omit(ifelse(is.na(viralload), NA , visit_num-1)),3)
                    
                    
                  )%>%
                  ungroup()
                  
                  
# handle AMPATH's data missing xrossection civilstatus
civilstatus.cx=getFirstNonNAInXMonths(patient.long,3,'civilstatus')%>%select(ptidno, civilstatus=var_new)

# handle all sites missing baseline features
Height.cx=getFirstNonNAInXMonths(patient.long,3,'Height')%>%select(ptidno, Height=var_new)
Weight.cx=getFirstNonNAInXMonths(patient.long,3,'Weight')%>%select(ptidno, Weight=var_new)
bmi.cx=getFirstNonNAInXMonths(patient.long,3,'bmi')%>%select(ptidno, bmi=var_new)
nhif.cx=getFirstNonNAInXMonths(patient.long,3,'nhif')%>%select(ptidno, nhif=var_new)

# perform joining on the missing varibles
patient.cross = haven::read_sas("ak_vlmonitord.sas7bdat")%>%
                   mutate(transfer=ifelse(is.na(transfer)==T,0,1))%>%
                   left_join(civilstatus.cx,  c("ptidno"="ptidno"))%>%
                   left_join(Height.cx,  c("ptidno"="ptidno"))%>%
                   left_join(Weight.cx,  c("ptidno"="ptidno"))%>%
                   left_join(bmi.cx,  c("ptidno"="ptidno"))%>%
                   left_join(nhif.cx,  c("ptidno"="ptidno"))%>%
                   mutate(
                      civilstatusENROL=ifelse(program=="AMPATH",civilstatus,civilstatusENROL)
                    )

#merge master dataset
dataset=patient.cross %>%  left_join(select(patient.long,
                              num_days_to_vl1,num_days_to_vl2,num_days_to_vl3,
                              days_from_vl1_vl2,days_from_vl2_vl3,
                              vl_count1,vl_count2,vl_count3,ptidno,
                              num_encs_to_vl1,num_encs_to_vl2,num_encs_to_vl3
  
                            ),  c("ptidno"="ptidno"))
#Replace numerical codes with strings from codebook
dataset$civilstatusENROL <- factor(civstfmt.cb[match(dataset$civilstatusENROL, civstfmt.cb$code), ]$label)
dataset$male <- factor(zeroonefmt.cb[match(dataset$male, zeroonefmt.cb$code), ]$label)
dataset$transfer <- factor(zeroonefmt.cb[match(dataset$transfer, zeroonefmt.cb$code), ]$label)
dataset$Death <- factor(zeroonefmt.cb[match(dataset$Death, zeroonefmt.cb$code), ]$label)
dataset$nhif <- factor(zeroonefmt.cb[match(dataset$nhif, zeroonefmt.cb$code), ]$label)
dataset$entrypoint = factor(entptfmt.cb[match(dataset$entrypoint, entptfmt.cb$code), ]$label) 

dataset= dataset %>% 
                 mutate(across(c('Death','male', 'entrypoint', "civilstatusENROL", "transfer", "nhif"), as.factor)) 
                  # assuming if not 1 is 0

# Relevel
varList= list(
"Yes"=c('male','transfer','Death')
)
#dataset= relevelBy(varList,dataset) 


#str(dataset)
```


* We have assumed if is.na(transfer) then No else Yes
* Unrecorded data (occuring at the 1st encounter) on Hight, Weight, BMI, NHIF have be replaced with non-null next encounter recorded < 3 months from the first encounter
* Viral Load index detection - It is not possible to know when the next VL is drawn longitudinaly, as shown in the table below. As such we are treating each VL result as individual tests ordered independently.

```{r warning=F, eval=F}
patient.long %>% select(ptidno,visit_num,apptdate,VLundetectable,viralload,viralloadc,Height)%>%  
   filter(ptidno==52764) %>% arrange(ptidno, `apptdate`)  %>% kable () %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```


## Socio-demographics | Program
```{r fig.align='center',warning=FALSE}
na.rm.var=F;stats=T

# Getting descriptive statistics 
mergeDesc(
  "male gender" = getTable1Stats("male","program",desc_both,statistics=stats,na.rm=na.rm.var),       
  "death" = getTable1Stats("Death","program",desc_both,statistics=stats,na.rm=na.rm.var),   
  "civil status at enrollment" = getTable1Stats("civilstatusENROL","program",desc_both,statistics=stats,na.rm=na.rm.var), 
  "patient transferred out" = getTable1Stats("transfer","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "Height (cm) at enrollment" = getTable1Stats("Height","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "Weight (kg) at enrollment" = getTable1Stats("Weight","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "BMI at enrollment" = getTable1Stats("bmi","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "entry point to care" = getTable1Stats("entrypoint","program",desc_both,statistics=stats,na.rm=na.rm.var)
  #"NHIF at enrollment" = getTable1Stats("nhif","program",desc_both,statistics=stats,na.rm=na.rm.var)
          
          )%>%
   htmlTable( caption  = "<b> Socio-demographics </b>",useViewer=T,ctable = TRUE, align = 'lcccc',
              n.cgroup = c(1,9,1 ), cgroup = c('', 'Programs', '') ,tfoot="<sup>&Dagger;</sup>"
              )%>% htmlTable::addHtmlTableStyle(col.rgroup = c("#FFF", "#EEF")) 



```

## Viral Load Count | Programs
```{r fig.align='center',warning=FALSE}
na.rm.var=F;stats=T

# Getting descriptive statistics 
mergeDesc(
  "num_days_to_vl1" = getTable1Stats("num_days_to_vl1","program",desc_both,statistics=stats,na.rm=na.rm.var),       
  "num_days_to_vl2" = getTable1Stats("num_days_to_vl2","program",desc_both,statistics=stats,na.rm=na.rm.var),   
  "num_days_to_vl3" = getTable1Stats("num_days_to_vl3","program",desc_both,statistics=stats,na.rm=na.rm.var), 
  "days_from_vl1_vl2" = getTable1Stats("days_from_vl1_vl2","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "days_from_vl2_vl3" = getTable1Stats("days_from_vl2_vl3","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "vl_count1" = getTable1Stats("vl_count1","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "vl_count2" = getTable1Stats("vl_count2","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "vl_count3" = getTable1Stats("vl_count3","program",desc_both,statistics=stats,na.rm=na.rm.var),
   "num_encs_to_vl1" = getTable1Stats("vl_count1","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "num_encs_to_vl2" = getTable1Stats("num_encs_to_vl2","program",desc_both,statistics=stats,na.rm=na.rm.var),
  "num_encs_to_vl3" = getTable1Stats("num_encs_to_vl3","program",desc_both,statistics=stats,na.rm=na.rm.var)
  #"NHIF at enrollment" = getTable1Stats("nhif","program",desc_both,statistics=stats,na.rm=na.rm.var)
          
          )%>%
   htmlTable( caption  = "<b> Socio-demographics </b>",useViewer=T,ctable = TRUE, align = 'lcccc',
              n.cgroup = c(1,9,1 ), cgroup = c('', 'Programs', '') ,tfoot="<sup>&Dagger;</sup>"
              )%>% htmlTable::addHtmlTableStyle(col.rgroup = c("#FFF", "#EEF")) 



```